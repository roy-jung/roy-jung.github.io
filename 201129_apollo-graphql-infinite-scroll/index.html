<!DOCTYPE html><html lang="ko-KR"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>infinite scroll 구현하기 (1) apollo-graphql | FE재남</title><link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/highlights/dracula.css"><link rel="canonical" href="http://roy-jung.github.io/201129_apollo-graphql-infinite-scroll/"/>
<meta name="description" content="최근 swr이라는 fetch 전용 라이브러리가 핫합니다. 내용을 살펴보았는데, apollo-graphql을 이용할 때와 뭐가 얼마나 다를지가 잘 그려지지 않아서 이참에 연습을 좀 해보았습니다. 원래는 swr을 연습하기 위한 것이었는데 막상 작업을…">
<meta property="og:type" content="article">
<meta property="og:title" content="infinite scroll 구현하기 (1) apollo-graphql">
<meta property="og:url" content="http://roy-jung.github.io/201129_apollo-graphql-infinite-scroll/">
<meta property="og:site_name" content="FE재남">
<meta property="og:description" content="최근 swr이라는 fetch 전용 라이브러리가 핫합니다. 내용을 살펴보았는데, apollo-graphql을 이용할 때와 뭐가 얼마나 다를지가 잘 그려지지 않아서 이참에 연습을 좀 해보았습니다. 원래는 swr을 연습하기 위한 것이었는데 막상 작업을…">
<meta property="og:locale" content="ko_KR">
<meta property="og:image" content="http://roy-jung.github.io/201129_apollo-graphql-infinite-scroll/0.png">
<meta property="article:published_time" content="2020-11-28T11:07:08.000Z">
<meta property="article:modified_time" content="2025-04-02T11:37:01.499Z">
<meta property="article:author" content="Jaenam Jung">
<meta property="article:tag" content="React.js">
<meta property="article:tag" content="Apollo">
<meta property="article:tag" content="graphQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://roy-jung.github.io/201129_apollo-graphql-infinite-scroll/0.png"><meta property="article:author" content="Jaenam Jung"><meta property="twitter:label1" content="Published at"><meta property="twitter:data1" content="2020-11-28 20:07:08"><meta property="twitter:label2" content="Written by"><meta property="twitter:data2" content="Jaenam Jung"><link rel="icon" href="/images/logo.png"><link rel="alternate" href="/atom.xml" type="application/atom+xml" title="FE재남"><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="https://schema.org/WebPage"><nav class="menu" id="menu"><div class="menu-inner"><div class="menu__left-area"><div class="menu__item"><a class="menu__item__link menu__item__link--brand" href="/" title="Home" rel="home"><img class="menu__item__link--brand__image" src="/images/logo.png" alt="FE재남"><span class="menu__item__link--brand__label">FE재남</span></a></div></div><div class="menu__right-area"><div class="menu__item"><a class="menu__item__link" href="/">Home</a></div><div class="menu__item"><a class="menu__item__link" href="/about">About</a></div></div></div></nav><div class="page-background"></div><div class="content-container"><div class="content-outer"><div class="content-inner" itemscope itemtype="https://schema.org/Blog"><article class="article" id="article" itemscope itemtype="https://schema.org/BlogPosting"><h1 class="article__title" itemprop="headline">infinite scroll 구현하기 (1) apollo-graphql</h1><div class="article__meta"><time class="article__meta__time" datetime="2020-11-28T11:07:08.000Z" itemprop="datePublished">2020-11-28 20:07:08</time><div class="article__meta__categories"><a class="article__meta__categories__item" href="/categories/fe/">FE</a><span class="article__meta__categories__separator">></span><a class="article__meta__categories__item" href="/categories/fe/react-js/">React.js</a></div></div><div class="article__contents"><img src="/201129_apollo-graphql-infinite-scroll/0.png"/><p>최근 <a target="_blank" rel="noopener" href="https://swr.vercel.app/">swr</a>이라는 fetch 전용 라이브러리가 핫합니다. 내용을 살펴보았는데, apollo-graphql을 이용할 때와 뭐가 얼마나 다를지가 잘 그려지지 않아서 이참에 연습을 좀 해보았습니다. 원래는 swr을 연습하기 위한 것이었는데 막상 작업을 착수하고 보니 2020년 7월에 Apollo Client v3.이 릴리즈되었더군요. 기존 2.x대와 달라진 내용이 많아 이 부분에서 더 오랜 시간을 할애했습니다. 아직 Apollo Client v3. 환경에서 GraphQL로 무한스크롤을 구현한 예제가 거의 없는 것 같아, 겸사겸사 공유하고자 블로깅 합니다.</p>
<p>전체 코드는 <a target="_blank" rel="noopener" href="https://github.com/roy-jung/swr-gql/tree/graphql">제 깃헙</a>에 올려 놓았습니다.</p>
<p>우선 apollo-graphql로 간단한 앱을 하나 만들고(1부), 이를 토대로 swr로 migration 해보는 것(2부)이 목표입니다.</p>
<h2 id="back-end"><a href="#back-end" class="headerlink" title="back-end"></a>back-end</h2><p>back-end 파트는 graphql의 동작을 확인할 수만 있으면 되기에, 최대한 간단한 방법을 이용했습니다. query는 단순히 json 파일을 불러오고, mutation은 node.js의 fs.writeFile을 이용하여 로컬 json을 계속 덮어씌우는 방식으로 구현했습니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./writeModel.js</span></span><br><span class="line"><span class="keyword">const</span> filenames = &#123;</span><br><span class="line">  <span class="attr">user</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../models/user.js&#x27;</span>),</span><br><span class="line">  <span class="attr">message</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;../models/message.js&#x27;</span>),</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">target, data</span>) =&gt;</span> &#123;</span><br><span class="line">  fs.<span class="title function_">writeFile</span>(filenames[target], <span class="string">`module.exports = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(data)&#125;</span>`</span>, <span class="function">(<span class="params">...err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./resolver/message.js</span></span><br><span class="line"><span class="keyword">const</span> messageResolvers = &#123;</span><br><span class="line">  <span class="title class_">Query</span>: &#123;</span><br><span class="line">    <span class="attr">messages</span>: <span class="function">(<span class="params">parent, &#123; lastMsgId = <span class="string">&#x27;&#x27;</span>, limit = <span class="number">15</span> &#125;, &#123; models &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> messageIds = <span class="title class_">Object</span>.<span class="title function_">keys</span>(models.<span class="property">messages</span>).<span class="title function_">reverse</span>()</span><br><span class="line">      <span class="keyword">const</span> nextIndex = messageIds.<span class="title function_">indexOf</span>(lastMsgId)</span><br><span class="line">      <span class="keyword">return</span> (nextIndex === -<span class="number">1</span> ? messageIds.<span class="title function_">slice</span>(<span class="number">0</span>, limit) : messageIds.<span class="title function_">slice</span>(nextIndex, nextIndex + limit + <span class="number">1</span>)).<span class="title function_">map</span>(</span><br><span class="line">        <span class="function"><span class="params">id</span> =&gt;</span> models.<span class="property">messages</span>[id],</span><br><span class="line">      )</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">message</span>: <span class="function">(<span class="params">parent, &#123; id &#125;, &#123; models &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> models.<span class="property">messages</span>[id]</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title class_">Mutation</span>: &#123;</span><br><span class="line">    <span class="attr">createMessage</span>: <span class="function">(<span class="params">parent, &#123; text &#125;, &#123; me, models &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> id = <span class="title function_">uuidv4</span>()</span><br><span class="line">      <span class="keyword">const</span> message = &#123;</span><br><span class="line">        id,</span><br><span class="line">        text,</span><br><span class="line">        <span class="attr">userId</span>: me.<span class="property">id</span>,</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="title class_">String</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>()),</span><br><span class="line">      &#125;</span><br><span class="line">      models.<span class="property">messages</span>[id] = message</span><br><span class="line">      <span class="title function_">writeModel</span>(<span class="string">&#x27;message&#x27;</span>, models.<span class="property">messages</span>)</span><br><span class="line">      <span class="keyword">return</span> message</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...생략</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title class_">Message</span>: &#123;</span><br><span class="line">    <span class="attr">user</span>: <span class="function">(<span class="params">message, args, &#123; models &#125;</span>) =&gt;</span> models.<span class="property">users</span>[message.<span class="property">userId</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>message list를 무한스크롤 방식으로 fetch하기 위해 가장 중요한 부분이 바로 pagination 처리일텐데, 최소한의 실시간성이 보장되어야 하는 환경, 즉 트위터나 페이스북 같은 경우를 상정했을 때엔 단순히 ‘페이지’ 단위로 리스트를 불러오는 것은 리스크가 있을 것입니다. 예를 들어 DB의 변화가 없는 경우라면 최초 1페이지의 메시지ID 목록이 최신순으로 <code>[40, 39, 38, 37, 36]</code>라고 했을 때 2페이지는 <code>[35, 34, 33, 32, 31]</code>이 되어야 맞겠지만, 그 사이 누군가 ID가 37인 글을 삭제하여 DB상에는 ID 37에 해당하는 글이 사라진 상태인 경우 2페이지는 <code>[34, 33, 32, 31, 30]</code>가 되어버립니다. 새 글이 추가된 경우에도 역시 페이지네이션은 꼬여버릴 수밖에 없습니다. 따라서 저는 화면상의 마지막 ID(lastMsgId)를 기준으로 다음 리스트를 불러오는 방식을 취했습니다. 그밖엔 백엔드 파트에선 특별히 언급할 내용이 없네요. 빠르게 프론트엔드 파트로 넘어가겠습니다.</p>
<h2 id="front-end"><a href="#front-end" class="headerlink" title="front-end"></a>front-end</h2><p>front-end는 react.js, next.js, apollo-client를 기반으로 작업하였습니다.</p>
<h3 id="apollo-setting"><a href="#apollo-setting" class="headerlink" title="apollo setting"></a>apollo setting</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./apollo.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ApolloClient</span>, <span class="title class_">InMemoryCache</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@apollo/client&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; withApollo &#125; <span class="keyword">from</span> <span class="string">&#x27;next-with-apollo&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">mergeItems</span> = (<span class="params">a = [], b = []</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Set</span>([...a, ...b].<span class="title function_">map</span>(<span class="function"><span class="params">m</span> =&gt;</span> m.<span class="property">__ref</span>))).<span class="title function_">map</span>(<span class="function"><span class="params">r</span> =&gt;</span> (&#123; <span class="attr">__ref</span>: r &#125;))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> messagePolicies = &#123;</span><br><span class="line">  <span class="title function_">read</span>(<span class="params">existing</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> existing</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">merge</span>(<span class="params">existing = [], incoming = [], &#123; args: &#123; lastMsgId &#125;, readField &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> extIndex = existing.<span class="title function_">findIndex</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">readField</span>(<span class="string">&#x27;id&#x27;</span>, e) === lastMsgId)</span><br><span class="line">    <span class="keyword">if</span> (extIndex &gt; -<span class="number">1</span>) <span class="keyword">return</span> <span class="title function_">mergeItems</span>(existing, incoming)</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">mergeItems</span>(incoming, existing)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">initializeApollo</span> = props =&gt;</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">ApolloClient</span>(&#123;</span><br><span class="line">    <span class="attr">uri</span>: <span class="string">&#x27;http://localhost:8000/graphql&#x27;</span>,</span><br><span class="line">    <span class="attr">cache</span>: <span class="keyword">new</span> <span class="title class_">InMemoryCache</span>(&#123;</span><br><span class="line">      <span class="attr">typePolicies</span>: &#123;</span><br><span class="line">        <span class="title class_">Query</span>: &#123;</span><br><span class="line">          <span class="attr">fields</span>: &#123;</span><br><span class="line">            <span class="attr">messages</span>: messagePolicies,</span><br><span class="line">            <span class="attr">userMessages</span>: messagePolicies,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;).<span class="title function_">restore</span>(props?.<span class="property">initialState</span> || &#123;&#125;),</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getStandaloneApolloClient</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="title class_">ApolloClient</span>, <span class="title class_">InMemoryCache</span>, <span class="title class_">HttpLink</span> &#125; = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;@apollo/client&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">initializeApollo</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> withApolloClient = <span class="title function_">withApollo</span>(initializeApollo)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withApolloClient</span><br></pre></td></tr></table></figure>

<p>ApolloClient v3.에서 가장 달라진 점은 뭐니뭐니해도 <code>typePolicies</code> 부분일 것입니다. 이 부분만 요구사항에 맞게 잘 구현해 놓으면 컴포넌트에서 제어해야 하는 부분이 상당히 줄어드는 것 같습니다. 그런데 그런것치고는 제가 느끼기에는 공식 문서가 좀 빈약하여 애를 많이 먹었습니다.<br>각 필드별로 정책을 달리 할 수 있는데, query가 호출될 때마다 해당 정책 내의 모든 메서드가 실행됩니다. 제 코드상에서는 read와 merge가 실행됩니다. 공식문서에는 merge 부분에서 단순히 <code>return [...existing, ...incoming]</code> 식으로 처리하라고 되어있는데, 이러면 상황에 따라 데이터가 중복되어 버립니다. 중복을 제거하기 위해 <code>mergeItems</code>라는 메서드를 따로 만들어야 했습니다. read 없이 merge만 있는 경우, fetchMore시 새로 불러온 데이터만 화면에 노출되게 됩니다.</p>
<h3 id="graphql"><a href="#graphql" class="headerlink" title="graphql"></a>graphql</h3><figure class="highlight graphql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./graphql/message.gql</span></span><br><span class="line"><span class="keyword">query</span> GET_MESSAGES<span class="punctuation">(</span><span class="variable">$lastMsgId</span>: ID <span class="punctuation">=</span> <span class="string">&quot;&quot;</span>, <span class="variable">$limit</span>: Int<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  messages<span class="punctuation">(</span><span class="symbol">lastMsgId</span><span class="punctuation">:</span> <span class="variable">$lastMsgId</span>, <span class="symbol">limit</span><span class="punctuation">:</span> <span class="variable">$limit</span>) <span class="punctuation">&#123;</span></span><br><span class="line">    id</span><br><span class="line">    text</span><br><span class="line">    user <span class="punctuation">&#123;</span></span><br><span class="line">      id</span><br><span class="line">      nickname</span><br><span class="line">      fullname</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    timestamp</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="comment"># 이하 생략</span></span><br></pre></td></tr></table></figure>

<figure class="highlight graphql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./graphql/user.gql</span></span><br><span class="line"><span class="keyword">query</span> GET_USER<span class="punctuation">(</span><span class="variable">$id</span>: ID<span class="punctuation">!</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  user<span class="punctuation">(</span><span class="symbol">id</span><span class="punctuation">:</span> <span class="variable">$id</span>) <span class="punctuation">&#123;</span></span><br><span class="line">    id</span><br><span class="line">    fullname</span><br><span class="line">    nickname</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="keyword">query</span> GET_USER_MESSAGES<span class="punctuation">(</span><span class="variable">$id</span>: ID<span class="punctuation">!</span>, <span class="variable">$lastMsgId</span>: ID, <span class="variable">$limit</span>: Int<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  userMessages<span class="punctuation">(</span><span class="symbol">id</span><span class="punctuation">:</span> <span class="variable">$id</span>, <span class="symbol">lastMsgId</span><span class="punctuation">:</span> <span class="variable">$lastMsgId</span>, <span class="symbol">limit</span><span class="punctuation">:</span> <span class="variable">$limit</span>) <span class="punctuation">&#123;</span></span><br><span class="line">    id</span><br><span class="line">    text</span><br><span class="line">    timestamp</span><br><span class="line">    user <span class="punctuation">&#123;</span></span><br><span class="line">      nickname</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>user/[id] 페이지에서는 해당 유저의 글목록을 노출하고자 했습니다. <code>GET_USER_MESSAGES</code>는 userId가 필요하다는 점을 제외하곤 모든 면에서 <code>GET_MESSAGES</code>와 동일합니다.</p>
<h3 id="pages"><a href="#pages" class="headerlink" title="pages"></a>pages</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./pages/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">CREATE_MESSAGE</span>, <span class="variable constant_">GET_MESSAGES</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../graphql/message.gql&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> msgTarget = <span class="string">&#x27;messages&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Home</span> = (<span class="params">&#123; smsgs &#125;</span>) =&gt; (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">MsgInput</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">updateQuery</span>=<span class="string">&#123;GET_MESSAGES&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">updateTarget</span>=<span class="string">&#123;msgTarget&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">mutationQuery</span>=<span class="string">&#123;CREATE_MESSAGE&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">mutationTarget</span>=<span class="string">&quot;createMessage&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">MsgList</span> <span class="attr">updateTarget</span>=<span class="string">&#123;msgTarget&#125;</span> <span class="attr">updateQuery</span>=<span class="string">&#123;GET_MESSAGES&#125;</span> <span class="attr">smsgs</span>=<span class="string">&#123;smsgs&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getServerSideProps</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> apolloClient = <span class="keyword">await</span> <span class="title function_">getStandaloneApolloClient</span>()</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> apolloClient.<span class="title function_">query</span>(&#123; <span class="attr">query</span>: <span class="variable constant_">GET_MESSAGES</span> &#125;)</span><br><span class="line">  <span class="keyword">const</span> initialState = apolloClient.<span class="property">cache</span>.<span class="title function_">extract</span>()</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      initialState,</span><br><span class="line">      <span class="attr">smsgs</span>: res.<span class="property">data</span>?.[msgTarget],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MsgList 컴포넌트를 뒤이어 나올 <code>user/[id]</code> 에서도 활용하기 위해, ‘updateQuery, updateTarget’의 두 개의 프로퍼티를 작성했습니다. <code>/</code>(root)에서는 <code>GET_MESSAGE</code>(updateQuery)로 쿼리를 보내고, 그 결과는 <code>&#123;data: messages: [MSG] &#125;</code>가 되는 반면(updateTarget), <code>/user/[id]</code>에서는 <code>GET_USER_MESSAGES</code>(updateQuery)로 쿼리를 보내고, 그 결과는 <code>&#123;data: userMessages: [MSG] &#125;</code>가 됩니다(updateTarget).</p>
<p>한편 MsgInput은 새 글을 작성할 때도 사용하고, 이미 작성한 글을 수정할 때도 사용합니다. 새 글 작성시에는 mutation으로 <code>CREATE_MESSAGE</code>(mutationQuery)를 보내고, 그 결과는 <code>&#123;data: createMessage: MSG &#125;</code>가 되며(mutationTarget), 이를 <code>messages</code>에 반영(udpateTarget)하기 위해 기존 메시지 리스트를 불러와야(updateQuery) 합니다. 글 수정은 <code>/</code>(root)에서도 할 수 있고, <code>/user/[id]</code>에서도 할 수 있어야 합니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/user/[id].js</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">GET_USER</span>, <span class="variable constant_">GET_USER_MESSAGES</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../../graphql/user.gql&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> msgsTarget = <span class="string">&#x27;userMessages&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">User</span> = (<span class="params">&#123; suser, smsgs &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> router = <span class="title function_">useRouter</span>()</span><br><span class="line">  <span class="keyword">const</span> id = router.<span class="property">query</span>.<span class="property">id</span></span><br><span class="line">  <span class="keyword">const</span> [getUser, &#123; <span class="attr">data</span>: userData &#125;] = <span class="title function_">useLazyQuery</span>(<span class="variable constant_">GET_USER</span>)</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(suser || &#123;&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!suser) <span class="title function_">getUser</span>(&#123; <span class="attr">variables</span>: &#123; id &#125; &#125;)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (userData?.<span class="property">user</span>) <span class="title function_">setUser</span>(userData.<span class="property">user</span>)</span><br><span class="line">  &#125;, [userData])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; nickname, fullname &#125; = user</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Header</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;nickname&#125; &#123;fullname&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">MsgList</span> <span class="attr">updateTarget</span>=<span class="string">&#123;msgsTarget&#125;</span> <span class="attr">updateQuery</span>=<span class="string">&#123;GET_USER_MESSAGES&#125;</span> <span class="attr">variables</span>=<span class="string">&#123;&#123;</span> <span class="attr">id</span> &#125;&#125; <span class="attr">smsgs</span>=<span class="string">&#123;smsgs&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getServerSideProps</span> = <span class="keyword">async</span> (<span class="params">&#123; query: &#123; id &#125; &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> apolloClient = <span class="keyword">await</span> <span class="title function_">getStandaloneApolloClient</span>()</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    apolloClient.<span class="title function_">query</span>(&#123; <span class="attr">query</span>: <span class="variable constant_">GET_USER</span>, <span class="attr">variables</span>: &#123; id &#125; &#125;),</span><br><span class="line">    apolloClient.<span class="title function_">query</span>(&#123; <span class="attr">query</span>: <span class="variable constant_">GET_USER_MESSAGES</span>, <span class="attr">variables</span>: &#123; id &#125; &#125;),</span><br><span class="line">  ])</span><br><span class="line">  <span class="keyword">const</span> initialState = apolloClient.<span class="property">cache</span>.<span class="title function_">extract</span>()</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      initialState,</span><br><span class="line">      <span class="attr">suser</span>: res[<span class="number">0</span>].<span class="property">data</span>?.<span class="property">user</span>,</span><br><span class="line">      <span class="attr">smsgs</span>: res[<span class="number">1</span>].<span class="property">data</span>?.[msgsTarget],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>/user/[id] 에서는 SSR로 user정보와 userMessages를 모두 호출했습니다. SSR이 호출되는 경우도 있고 그렇지 않은 경우도 있는데, 그렇지 않은 경우에는 LazyQuery로 최초 render시 한 번만 호출하게끔 했습니다.</p>
<h3 id="components"><a href="#components" class="headerlink" title="components"></a>components</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./components/MsgInput.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">MsgInput</span> = (<span class="params">&#123;</span></span><br><span class="line"><span class="params">  mutationQuery,</span></span><br><span class="line"><span class="params">  mutationTarget,</span></span><br><span class="line"><span class="params">  updateQuery,</span></span><br><span class="line"><span class="params">  updateTarget,</span></span><br><span class="line"><span class="params">  text = <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="params">  doneEdit,</span></span><br><span class="line"><span class="params">  variables = &#123;&#125;,</span></span><br><span class="line"><span class="params">&#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [mutate, &#123; data &#125;] = <span class="title function_">useMutation</span>(mutationQuery)</span><br><span class="line">  <span class="keyword">const</span> textRef = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onSubmit</span> = e =&gt; &#123;</span><br><span class="line">    e.<span class="title function_">preventDefault</span>()</span><br><span class="line">    <span class="keyword">const</span> text = textRef.<span class="property">current</span>.<span class="property">value</span></span><br><span class="line">    <span class="title function_">mutate</span>(&#123;</span><br><span class="line">      <span class="attr">variables</span>: &#123; ...variables, text &#125;,</span><br><span class="line">      <span class="attr">update</span>: <span class="function">(<span class="params">cache, &#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!variables.<span class="property">id</span>) &#123;</span><br><span class="line">          cache.<span class="title function_">writeQuery</span>(&#123;</span><br><span class="line">            <span class="attr">query</span>: updateQuery,</span><br><span class="line">            <span class="attr">data</span>: &#123; [updateTarget]: [data[mutationTarget]] &#125;,</span><br><span class="line">          &#125;)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> res = cache.<span class="title function_">readQuery</span>(&#123; <span class="attr">query</span>: updateQuery &#125;)</span><br><span class="line">        <span class="keyword">const</span> source = [...res[updateTarget]]</span><br><span class="line">        <span class="keyword">const</span> targetIndex = source.<span class="title function_">findIndex</span>(<span class="function"><span class="params">m</span> =&gt;</span> m.<span class="property">id</span> === variables.<span class="property">id</span>)</span><br><span class="line">        <span class="keyword">if</span> (targetIndex &lt; <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line">        source[targetIndex] = data[mutationTarget]</span><br><span class="line">        cache.<span class="title function_">writeQuery</span>(&#123;</span><br><span class="line">          <span class="attr">query</span>: updateQuery,</span><br><span class="line">          <span class="attr">data</span>: &#123; [updateTarget]: source &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    textRef.<span class="property">current</span>.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    doneEdit &amp;&amp; <span class="title function_">doneEdit</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">className</span>=<span class="string">&quot;messages_input&quot;</span> <span class="attr">onSubmit</span>=<span class="string">&#123;onSubmit&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">maxLength</span>=<span class="string">&quot;140&quot;</span> <span class="attr">ref</span>=<span class="string">&#123;textRef&#125;</span> <span class="attr">defaultValue</span>=<span class="string">&#123;text&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>전송<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MsgInput 컴포넌트는 인덱스 최상단의 ‘새글작성’ 및 각 메시지의 ‘수정’ 모두에서 활용합니다. 때문에 onSubmit 함수의 <code>mutate</code> 부분이 조금 길어졌습니다. 새 글은 writeQuery만으로 충분하지만, 수정의 경우 로딩된 글목록에 대상 메시지가 존재할 경우에만 cache를 업데이트해주어야 합니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">useInfiniteScroll</span> = (<span class="params">targetEl, ssr = <span class="literal">false</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> observerRef = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> isFirstRender = <span class="title function_">useRef</span>(!ssr)</span><br><span class="line">  <span class="keyword">const</span> [isIntersecting, setIntersecting] = <span class="title function_">useState</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> [loadFinished, setLoadFinished] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> getObserver = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!observerRef.<span class="property">current</span>) &#123;</span><br><span class="line">      observerRef.<span class="property">current</span> = <span class="keyword">new</span> <span class="title class_">IntersectionObserver</span>(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> intersecting = entries.<span class="title function_">some</span>(<span class="function"><span class="params">entry</span> =&gt;</span> entry.<span class="property">isIntersecting</span>)</span><br><span class="line">        <span class="keyword">if</span> (isFirstRender.<span class="property">current</span> &amp;&amp; intersecting) &#123;</span><br><span class="line">          isFirstRender.<span class="property">current</span> = <span class="literal">false</span></span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">setIntersecting</span>(intersecting)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> observerRef.<span class="property">current</span></span><br><span class="line">  &#125;, [observerRef.<span class="property">current</span>])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> stopObserving = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">getObserver</span>().<span class="title function_">disconnect</span>()</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (targetEl.<span class="property">current</span>) <span class="title function_">getObserver</span>().<span class="title function_">observe</span>(targetEl.<span class="property">current</span>)</span><br><span class="line">    <span class="keyword">return</span> stopObserving</span><br><span class="line">  &#125;, [targetEl.<span class="property">current</span>])</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (loadFinished) <span class="title function_">stopObserving</span>()</span><br><span class="line">  &#125;, [loadFinished])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [isIntersecting, loadFinished, setLoadFinished]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>intersectionObserver를 이용한 hook입니다. targetEl이 intersecting된 경우에 isIntersecting이 true가 됩니다. 더이상 불러올 데이터가 없을 경우 setLoadFinished를 호출하여 loadFinished 값이 true가 되도록 했습니다. SSR 값이 있는 경우에는 isFirstRender가 처음부터 false가 되도록 했습니다. SSR 값이 없을 경우에는 useInfiniteScroll이 처음 렌더되는 시점이 query data가 로딩되기 전이기 때문에, isFirstRender를 true로 하여 isIntersecting에 의한 fetchmore 트리거가 동작하지 않게끔 처리했습니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./src/components/MsgList</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">MsgList</span> = (<span class="params">&#123; updateQuery, updateTarget, variables = &#123;&#125;, smsgs &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [lastMsgId, setLastMsgId] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> [editingMsgId, setEditingMsgId] = <span class="title function_">useState</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> [msgs, setMsgs] = <span class="title function_">useState</span>(smsgs || [])</span><br><span class="line">  <span class="keyword">const</span> &#123; data, error, fetchMore &#125; = <span class="title function_">useQuery</span>(updateQuery, &#123; variables &#125;)</span><br><span class="line">  <span class="keyword">const</span> fetchMoreEl = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> [intersecting, loadFinished, setLoadFinished] = <span class="title function_">useInfiniteScroll</span>(fetchMoreEl, !!smsgs)</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">id</span>: incomingId &#125; = msgs[msgs.<span class="property">length</span> - <span class="number">1</span>] || &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">doneEdit</span> = (<span class="params"></span>) =&gt; <span class="title function_">setEditingMsgId</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> messages = data?.[updateTarget]</span><br><span class="line">    <span class="keyword">if</span> (messages) <span class="title function_">setMsgs</span>(messages)</span><br><span class="line">  &#125;, [data?.[updateTarget]])</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!intersecting || loadFinished || !incomingId) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">data</span>: fetchMoreData &#125; = <span class="keyword">await</span> <span class="title function_">fetchMore</span>(&#123;</span><br><span class="line">      <span class="attr">variables</span>: &#123; ...variables, <span class="attr">lastMsgId</span>: incomingId &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">setLastMsgId</span>(incomingId)</span><br><span class="line">    <span class="keyword">if</span> (fetchMoreData[updateTarget].<span class="property">length</span> &lt; <span class="number">15</span>) <span class="title function_">setLoadFinished</span>(<span class="literal">true</span>)</span><br><span class="line">  &#125;, [intersecting])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (error) <span class="variable language_">console</span>.<span class="title function_">error</span>(error)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ul</span> <span class="attr">className</span>=<span class="string">&quot;messages&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;msgs.map(msg =&gt; (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">MsgItem</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#123;<span class="attr">...msg</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">key</span>=<span class="string">&#123;msg.id&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">updateQuery</span>=<span class="string">&#123;updateQuery&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">updateTarget</span>=<span class="string">&#123;updateTarget&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">editing</span>=<span class="string">&#123;editingMsgId</span> === <span class="string">msg.id&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">startEdit</span>=<span class="string">&#123;()</span> =&gt;</span> setEditingMsgId(msg.id)&#125;</span></span><br><span class="line"><span class="language-xml">            doneEdit=&#123;doneEdit&#125;</span></span><br><span class="line"><span class="language-xml">          /&gt;</span></span><br><span class="line"><span class="language-xml">        ))&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;fetchMoreEl&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>앞서 apollo.js에서 typePolicies를 정의해두었기 때문에 fethMore에서 cache에 관여할 필요가 없습니다.</p>
<h2 id="마치며"><a href="#마치며" class="headerlink" title="마치며"></a>마치며</h2><p>다음 파트에서 본격적으로 swr로 바꿔보겠습니다. (<a target="_blank" rel="noopener" href="https://github.com/roy-jung/swr-gql/tree/swr">깃헙</a>에는 이미 코드를 올려놓긴 헀습니다..)</p>
<p>뭘 더 적어야 좋을지 모르겠네요…하하 (도망)</p>
</div><div class="article__tags"><a class="article__tags__item" href="/tags/react-js/">React.js</a><a class="article__tags__item" href="/tags/apollo/">Apollo</a><a class="article__tags__item" href="/tags/graphql/">graphQL</a></div><div class="article__author" itemscope itemprop="author" itemtype="https://schema.org/Person"><img class="article__author__image" src="https://www.gravatar.com/avatar/02e9f56a3202da2e6e0e36a5a23facbb" alt="Jaenam Jung"><a class="article__author__link" title="About Jaenam Jung" rel="author">Jaenam Jung</a><p class="article__author__desc">할 수 있는걸 합니다.</p><div class="article__author__socials"><a class="article__author__socials__item" href="http://github.com/roy-jung" title="github" target="_blank"><i class="fa fa-github"></i></a><a class="article__author__socials__item" href="/atom.xml" title="rss" target="_blank"><i class="fa fa-rss"></i></a></div><meta itemprop="name" content="Jaenam Jung"></div><div class="sharer" id="sharer"><div class="sharer-inner"><div class="sharer__right"><button class="sharer__item" id="sharer-facebook"><i class="fa fa-facebook-official"></i></button><button class="sharer__item" id="sharer-twitter"><i class="fa fa-twitter"></i></button><button class="sharer__item" id="sharer-pinterest"><i class="fa fa-pinterest"></i></button><button class="sharer__item" id="sharer-pocket"><i class="fa fa-get-pocket"></i></button></div></div></div><!-- Disqus Code--><div id="disqus_thread"></div><script>(function() {
  var d = document, s = d.createElement('script');
  s.src = '//gomugom.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();</script><noscript>Enable JavaScript to see comments.</noscript><!-- Meta Tags for Structured Data--><meta itemprop="dateModified" content="2025-04-02T11:37:01.499Z"><meta itemprop="articleBody" content="최근 swr이라는 fetch 전용 라이브러리가 핫합니다. 내용을 살펴보았는데, apollo-graphql을 이용할 때와 뭐가 얼마나 다를지가 잘 그려지지 않아서 이참에 연습을 좀 해보았습니다. 원래는 swr을 연습하기 위한 것이었는데 막상 작업을 착수하고 보니 2020년 7월에 Apollo Client v3.이 릴리즈되었더군요. 기존 2.x대와..."><meta itemprop="url" content="http://roy-jung.github.io/201129_apollo-graphql-infinite-scroll/"><meta itemprop="mainEntityOfPage" content="http://roy-jung.github.io/201129_apollo-graphql-infinite-scroll/"><div itemscope itemtype="https://schema.org/Organization" itemprop="publisher"><meta itemprop="name" content="FE재남"><div itemscope itemprop="logo" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="http://roy-jung.github.io/images/logo.png"></div></div><div itemscope itemtype="https://schema.org/ImageObject" itemprop="image"><meta itemprop="contentUrl" content="http://roy-jung.github.io/201129_apollo-graphql-infinite-scroll/0.png"><meta itemprop="url" content="http://roy-jung.github.io/201129_apollo-graphql-infinite-scroll/0.png"><meta itemprop="width" content="200"><meta itemprop="height" content="200"></div></article><section class="related-posts"><h3>Related posts</h3><div class="related-posts__item__wrapper"><a class="related-posts__item" href="/201130_swr-graphql-infinite-scroll/"><div class="related-posts__item__background" style="background-image:url('/201130_swr-graphql-infinite-scroll/0.png');"></div><div class="related-posts__item__overlay"></div><span class="related-posts__item__title">infinite scroll 구현하기 (2) swr-graphql</span></a></div><div class="related-posts__item__wrapper"><a class="related-posts__item" href="/201111-concise-redux-saga/"><div class="related-posts__item__background" style="background-image:url('/images/post-cover4.jpg');"></div><div class="related-posts__item__overlay"></div><span class="related-posts__item__title">redux-saga를 간결하게 사용해보자!</span></a></div><div class="related-posts__item__wrapper"><a class="related-posts__item" href="/250414-react-reconciliation-deep-dive/"><div class="related-posts__item__background" style="background-image:url('/images/React Reconciliation Engine.webp');"></div><div class="related-posts__item__overlay"></div><span class="related-posts__item__title">React Reconciliation: 컴포넌트 뒤에 숨겨진 엔진</span></a></div></section></div></div></div><footer id="footer"><div class="widgets"><div class="widgets-inner"><!-- Jade doesn't support dynamic inclusion with `each`.--><!-- So, I just hard coded the file names that will be included.--><div class="widgets__item"><h3 class="widgets__item__heading">Recent posts</h3><ul class="recent-posts"><li class="recent-posts__item"><a href="/250701-history-of-js/">간략한 자바스크립트 역사</a></li><li class="recent-posts__item"><a href="/iterator-helper-overview/">이터레이터 헬퍼 맛보기</a></li><li class="recent-posts__item"><a href="/250414-react-reconciliation-deep-dive/">React Reconciliation: 컴포넌트 뒤에 숨겨진 엔진</a></li><li class="recent-posts__item"><a href="/250323-react-server-components/">리액트 서버 컴포넌트 톺아보기 (번역)</a></li><li class="recent-posts__item"><a href="/211231-review-2021/">2021 회고</a></li></ul></div><div class="widgets__item"><h3 class="widgets__item__heading">Archives</h3><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">2025 7월</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">2025 5월</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">2025 4월</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">2022 1월</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">2020 11월</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">2020 10월</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">2017 1월</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">2016 12월</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">2016 11월</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">2016 10월</a><span class="archive-list-count">2</span></li></ul></div><div class="widgets__item"><h3 class="widgets__item__heading">Categories</h3><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ecmascript/">ECMAScript</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fe/">FE</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/fe/react-js/">React.js</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/fe/react-js/next-js/">Next.js</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/fe/javascript/">javascript</a><span class="category-list-count">6</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/etc/">etc</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">1</span></li></ul></div></div></div><p class="copyright"><small>© 2025 Jaenam Jung<br>Powered by <a href="https://hexo.io" rel="external" target="_blank">Hexo</a>, Theme by <a href="https://github.com/hyunseob" rel="external" target="_blank">HyunSeob</a></small></p></footer><script src="/js/sharer.min.js"></script></body></html>